name: backend-ci-cd

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: backend-ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure Gradle wrapper is executable
        run: chmod +x gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build (Gradle)
        run: ${{ secrets.BACKEND_BUILD_CMD || './gradlew clean bootJar -x test' }}

      - name: Find built artifact
        id: jar
        shell: bash
        run: |
          set -e
          ART=$(ls -1 build/libs/*.jar | grep -v '\-plain\.jar$' | head -n1)
          echo "path=$ART" >> $GITHUB_OUTPUT
          echo "Found: $ART"

      - name: Upload artifact to EC2 (SCP)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "${{ steps.jar.outputs.path }}"   # 예: build/libs/app.jar
          target: "/srv/nurean/backend/releases/${{ github.sha }}/"
          overwrite: true
          strip_components: 2  # <<--- build/libs 제거 (경로 앞 2개 컴포넌트 제거)

      - name: Link, Restart, Health (one SSH)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          command_timeout: 10m
          script: |
            set -euo pipefail
            BASE="/srv/nurean/backend"
            REL="$BASE/releases/${{ github.sha }}"
            CUR="$BASE/current"

            echo "[INFO] Ensure release dir"
            mkdir -p "$REL" "$CUR"

            echo "[INFO] Pick artifact and normalize name"
            ART=$(find "$REL" -maxdepth 2 -type f \( -name "*.jar" -o -name "*.war" \) | head -n1 || true)
            if [ -z "$ART" ]; then
              echo "[ERROR] No artifact in $REL"
              ls -alR "$REL" || true
              exit 1
            fi
            mv -f "$ART" "$REL/app.jar"

            echo "[INFO] Update symlink"
            ln -sfn "$REL/app.jar" "$CUR/app.jar"
            ls -l "$CUR"

            echo "[INFO] Stop old app"
            "$BASE/stop.sh" || true

            echo "[INFO] Start app"
            "$BASE/run.sh" || { echo "[ERROR] run.sh failed"; tail -n 200 "$BASE/shared/logs/app.log" || true; exit 1; }

            echo "[INFO] Health check"
            for i in {1..60}; do
              sleep 1
              if curl -fsS http://127.0.0.1:8095/actuator/health | grep -q '"status":"UP"'; then
                echo "[INFO] App is UP"
                exit 0
              fi
            done
            echo "[ERROR] Health check failed"
            tail -n 200 "$BASE/shared/logs/app.log" || true
            exit 1
