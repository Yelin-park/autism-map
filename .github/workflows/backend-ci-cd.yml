name: backend-ci-cd

on:
  push:
    branches: [ "main" ]
    # 필요 시 특정 경로만 트리거하려면 paths 설정 추가 가능
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Gradle wrapper is executable
        run: chmod +x gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build (Gradle)
        run: ${{ secrets.BACKEND_BUILD_CMD || './gradlew clean build -x test' }}

      - name: Find built JAR
        id: jar
        run: |
          FILE=$(ls build/libs/*.jar | head -n1)
          echo "path=$FILE" >> $GITHUB_OUTPUT
          echo "Found JAR: $FILE"

      - name: Upload JAR to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "${{ steps.jar.outputs.path }}"
          target: "/srv/nurean/backend/releases/${{ github.sha }}/"
          overwrite: true

      - name: Activate & restart on EC2 (SSH)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            REL="/srv/nurean/backend/releases/${{ github.sha }}"
            JAR_SRC=$(ls "$REL"/*.jar | head -n1)
            mkdir -p /srv/nurean/backend/current
            ln -sfn "$JAR_SRC" /srv/nurean/backend/current/app.jar

            # 안전 재기동
            /srv/nurean/backend/stop.sh || true
            /srv/nurean/backend/run.sh

            # 헬스체크 (8095, /actuator/health)
            for i in {1..30}; do
              sleep 1
              if curl -fsS http://127.0.0.1:8095/actuator/health | grep -q '"status":"UP"'; then
                echo "App is UP"
                exit 0
              fi
            done
            echo "Health check failed"
            tail -n 200 /srv/nurean/backend/shared/logs/app.log || true
            exit 1
